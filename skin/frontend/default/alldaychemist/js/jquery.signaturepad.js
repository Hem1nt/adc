(function(a){function b(w,j){var u=this,A=a.extend({},a.fn.signaturePad.defaults,j),d=a(w),g=a(A.canvas,d),c=g.get(0),q=null,f={x:null,y:null},p=[],m=false,k=false,v=false;function s(G,E){var I=a(G.target).offset(),H,F;clearTimeout(m);m=false;if(typeof G.changedTouches!=="undefined"){H=Math.floor(G.changedTouches[0].pageX-I.left);F=Math.floor(G.changedTouches[0].pageY-I.top)}else{H=Math.floor(G.pageX-I.left);F=Math.floor(G.pageY-I.top)}if(f.x===H&&f.y===F){return true}if(f.x===null){f.x=H}if(f.y===null){f.y=F}if(E){F+=E}q.beginPath();q.moveTo(f.x,f.y);q.lineTo(H,F);q.lineCap=A.penCap;q.stroke();q.closePath();p.push({lx:H,ly:F,mx:f.x,my:f.y});f.x=H;f.y=F}function y(){if(k){g.each(function(){this.ontouchmove=null})}else{g.unbind("mousemove.signaturepad")}f.x=null;f.y=null;if(p.length>0){a(A.output,d).val(JSON.stringify(p))}}function n(){if(!A.lineWidth){return false}q.beginPath();q.lineWidth=A.lineWidth;q.strokeStyle=A.lineColour;q.moveTo(A.lineMargin,A.lineTop);q.lineTo(c.width-A.lineMargin,A.lineTop);q.stroke();q.closePath()}function r(){y();q.fillStyle=A.bgColour;q.fillRect(0,0,c.width,c.height);if(!A.displayOnly){n()}q.lineWidth=A.penWidth;q.strokeStyle=A.penColour;a(A.output,d).val("");p=[]}function C(E,F){if(k){g.each(function(){this.addEventListener("touchmove",s,false)})}else{g.bind("mousemove.signaturepad",s)}s(E,1)}function e(){v=false;if(k){g.each(function(){this.removeEventListener("touchstart",y);this.removeEventListener("touchend",y);this.removeEventListener("touchmove",s)})}else{g.unbind("mousedown.signaturepad");g.unbind("mouseup.signaturepad");g.unbind("mousemove.signaturepad");g.unbind("mouseleave.signaturepad")}a(A.clear,d).unbind("click.signaturepad")}function o(E){if(v){return false}v=true;if(typeof E.changedTouches!=="undefined"){k=true}if(k){g.each(function(){this.addEventListener("touchend",y,false);this.addEventListener("touchcancel",y,false)});g.unbind("mousedown.signaturepad")}else{g.bind("mouseup.signaturepad",function(F){y()});g.bind("mouseleave.signaturepad",function(F){if(!m){m=setTimeout(function(){y();clearTimeout(m);m=false},500)}});g.each(function(){this.ontouchstart=null})}}function l(){a(A.typed,d).hide();r();g.each(function(){this.ontouchstart=function(E){E.preventDefault();o(E);C(E,this)}});g.bind("mousedown.signaturepad",function(E){o(E);C(E,this)});a(A.clear,d).bind("click.signaturepad",function(E){E.preventDefault();r()});a(A.typeIt,d).bind("click.signaturepad",function(E){E.preventDefault();z()});a(A.drawIt,d).unbind("click.signaturepad");a(A.drawIt,d).bind("click.signaturepad",function(E){E.preventDefault()});a(A.typeIt,d).removeClass(A.currentClass);a(A.drawIt,d).addClass(A.currentClass);a(A.sig,d).addClass(A.currentClass);a(A.typeItDesc,d).hide();a(A.drawItDesc,d).show();a(A.clear,d).show()}function z(){r();e();a(A.typed,d).show();a(A.drawIt,d).bind("click.signaturepad",function(E){E.preventDefault();l()});a(A.typeIt,d).unbind("click.signaturepad");a(A.typeIt,d).bind("click.signaturepad",function(E){E.preventDefault()});a(A.output,d).val("");a(A.drawIt,d).removeClass(A.currentClass);a(A.typeIt,d).addClass(A.currentClass);a(A.sig,d).removeClass(A.currentClass);a(A.drawItDesc,d).hide();a(A.clear,d).hide();a(A.typeItDesc,d).show()}function i(F){a(A.typed,d).html(F.replace(/>/g,"&gt;").replace(/</g,"&lt;"));while(a(A.typed,d).width()>c.width){var E=a(A.typed,d).css("font-size").replace(/px/,"");a(A.typed,d).css("font-size",E-1+"px")}}function t(E,F){a("p."+F.errorClass,E).remove();E.removeClass(F.errorClass);a("input, label",E).removeClass(F.errorClass)}function B(G,E,F){if(G.nameInvalid){E.prepend(['<p class="',F.errorClass,'">',F.errorMessage,"</p>"].join(""));a(F.name,E).focus();a(F.name,E).addClass(F.errorClass);a("label[for="+a(F.name).attr("id")+"]",E).addClass(F.errorClass)}if(G.drawInvalid){E.prepend(['<p class="',F.errorClass,'">',F.errorMessageDraw,"</p>"].join(""))}}function h(){var G=true,H={drawInvalid:false,nameInvalid:false},F=[d,A],E=[H,d,A];if(A.onBeforeValidate&&typeof A.onBeforeValidate==="function"){A.onBeforeValidate.apply(u,F)}else{t.apply(u,F)}if(A.drawOnly&&p.length<100){H.drawInvalid=true;G=false}if(a(A.name,d).val()===""){H.nameInvalid=true;G=false}if(A.onFormError&&typeof A.onFormError==="function"){A.onFormError.apply(u,E)}else{B.apply(u,E)}return G}function D(H,F,G){for(var E in H){if(typeof H[E]==="object"){F.beginPath();F.moveTo(H[E].mx,H[E].my);F.lineTo(H[E].lx,H[E].ly);F.lineCap=A.penCap;F.stroke();F.closePath();if(G){p.push({lx:H[E].lx,ly:H[E].ly,mx:H[E].mx,my:H[E].my})}}}}function x(){if(parseFloat(((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent))||[0,"4_2"])[1].replace("_","."))<4.1){a.fn.Oldoffset=a.fn.offset;a.fn.offset=function(){var E=a(this).Oldoffset();E.top-=window.scrollY;E.left-=window.scrollX;return E}}a(A.typed,d).bind("selectstart.signaturepad",function(E){return a(E.target).is(":input")});g.bind("selectstart.signaturepad",function(E){return a(E.target).is(":input")});if(!c.getContext&&FlashCanvas){FlashCanvas.initElement(c)}if(c.getContext){q=c.getContext("2d");a(A.sig,d).show();if(!A.displayOnly){if(!A.drawOnly){a(A.name,d).bind("keyup.signaturepad",function(){i(a(this).val())});a(A.name,d).bind("blur.signaturepad",function(){i(a(this).val())});a(A.drawIt,d).bind("click.signaturepad",function(E){E.preventDefault();l()})}if(A.drawOnly||A.defaultAction==="drawIt"){l()}else{z()}if(A.validateFields){if(a(w).is("form")){a(w).bind("submit.signaturepad",function(){return h()})}else{a(w).parents("form").bind("submit.signaturepad",function(){return h()})}}a(A.sigNav,d).show()}}}a.extend(u,{init:function(){x()},regenerate:function(E){u.clearCanvas();a(A.typed,d).hide();if(typeof E==="string"){E=JSON.parse(E)}D(E,q,true);if(a(A.output,d).length>0){a(A.output,d).val(JSON.stringify(p))}},clearCanvas:function(){r()},getSignature:function(){return p},getSignatureString:function(){return JSON.stringify(p)},getSignatureImage:function(){var E=document.createElement("canvas"),F=null,G=null;E.style.position="absolute";E.style.top="-999em";E.width=c.width;E.height=c.height;document.body.appendChild(E);if(!E.getContext&&FlashCanvas){FlashCanvas.initElement(E)}F=E.getContext("2d");F.fillStyle=A.bgColour;F.fillRect(0,0,c.width,c.height);F.lineWidth=A.penWidth;F.strokeStyle=A.penColour;D(p,F);G=E.toDataURL.apply(E,arguments);document.body.removeChild(E);E=null;return G}})}a.fn.signaturePad=function(c){var d=null;this.each(function(){d=new b(this,c);d.init()});return d};a.fn.signaturePad.defaults={defaultAction:"typeIt",displayOnly:false,drawOnly:false,canvas:"canvas",sig:".sig",sigNav:".sigNav",bgColour:"#ffffff",penColour:"#145394",penWidth:2,penCap:"round",lineColour:"#ccc",lineWidth:2,lineMargin:5,lineTop:35,name:".name",typed:".typed",clear:".clearButton",typeIt:".typeIt a",drawIt:".drawIt a",typeItDesc:".typeItDesc",drawItDesc:".drawItDesc",output:".output",currentClass:"current",validateFields:true,errorClass:"error",errorMessage:"Please enter your name",errorMessageDraw:"Please sign the document",onBeforeValidate:null,onFormError:null}}(jQuery));